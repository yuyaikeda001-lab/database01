<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>関係者ログイン | データ登録</title>
    <style>
        body {
            font-family: "Yu Mincho", serif;
            background-color: #f0f0f0;
            padding: 20px;
            color: #333;
        }

        .form-container {
            background: white;
            padding: 30px;
            border: 1px solid #ccc;
            max-width: 700px;
            margin: 0 auto;
        }

        h1 {
            font-size: 20px;
            border-bottom: 2px solid #555;
            padding-bottom: 10px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #aaa;
        }

        label {
            display: block;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .google-btn {
            background-color: #fff;
            color: #757575;
            border: 1px solid #ddd;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            font-family: "Roboto", sans-serif;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
        }

        .google-btn:hover {
            background-color: #f8f8f8;
        }

        .google-icon {
            width: 18px;
            height: 18px;
            margin-right: 10px;
        }

        button.submit-btn {
            background-color: #0056b3;
            color: white;
            padding: 12px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }

        button.submit-btn:hover {
            background-color: #004494;
        }

        #login-section {
            text-align: center;
            max-width: 400px;
            margin: 50px auto;
            background: #fff;
            padding: 40px;
            border: 1px solid #ccc;
        }

        #upload-section {
            display: none;
        }

        .error-msg {
            color: red;
            font-weight: bold;
            margin-top: 15px;
            font-size: 13px;
        }

        .logout-btn {
            background-color: #666;
            font-size: 12px;
            padding: 5px 10px;
            color: #fff;
            border: none;
            cursor: pointer;
            float: right;
        }

        .input-note {
            font-size: 11px;
            color: #d00;
            margin-top: -8px;
            margin-bottom: 10px;
            display: block;
        }

        .dashboard-link {
            text-decoration: none;
            font-size: 12px;
            color: #0061ff;
        }
    </style>
</head>

<body>

    <div id="login-section">
        <h2>資料登録者ログイン</h2>
        <p>データ登録には管理者権限が必要です。</p>
        <button class="google-btn" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-icon">
            Googleでログイン
        </button>
        <p id="login-error" class="error-msg"></p>
        <p style="font-size:12px; margin-top:20px;">
            <a href="admin.html">← 管理画面へ</a> | <a href="takada.html">一覧に戻る</a>
        </p>
    </div>

    <div id="upload-section" class="form-container">
        <div style="overflow:hidden;">
            <button class="logout-btn" onclick="logout()">ログアウト</button>
            <h1 style="margin-top:0;">詳細データ登録</h1>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <p style="font-size:12px; color:#0056b3;">ログイン中: <span id="user-email-display"></span></p>
            <a href="admin.html" class="dashboard-link">管理者ダッシュボードへ</a>
        </div>

        <form id="uploadForm">
            <!-- DB Select -->
            <label>登録先データベース</label>
            <select id="target_collection" style="background:#eef; border:1px solid #aaf;">
                <option value="items">高田保馬 (Default)</option>
                <option value="items2">New Collection</option>
            </select>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label class="required">整理番号</label>
                    <input type="text" id="refNo" required placeholder="例: 1-1-1" pattern="^[0-9-]+$">
                    <span class="input-note">※半角数字とハイフン(-)のみ入力可</span>
                </div>
                <div style="flex:1;">
                    <label>形態</label>
                    <select id="form_type">
                        <option value="絵はがき">絵はがき</option>
                        <option value="絵はがき帳">絵はがき帳</option>
                        <option value="写真・アルバム">写真・アルバム</option>
                        <option value="書簡・封筒">書簡・封筒</option>
                        <option value="地図">地図</option>
                        <option value="書籍・冊子">書籍・冊子</option>
                        <option value="その他">その他</option>
                    </select>
                </div>
            </div>

            <label class="required">和文タイトル</label>
            <input type="text" id="title_jp" required>
            <label>英文タイトル</label>
            <input type="text" id="title_en">

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label>発行 (和文)</label> <input type="text" id="publisher_jp">
                </div>
                <div style="flex:1;">
                    <label>発行 (英文)</label> <input type="text" id="publisher_en">
                </div>
            </div>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label>使用/未使用</label>
                    <select id="usage_status">
                        <option value="">不明・指定なし</option>
                        <option value="未使用">未使用</option>
                        <option value="使用済み">使用済み</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label>消印日時</label> <input type="text" id="postmark_date">
                </div>
            </div>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label>仕切り線位置</label>
                    <select id="divider_loc">
                        <option value="-">-</option>
                        <option value="なし">なし</option>
                        <option value="1/3">1/3</option>
                        <option value="1/2">1/2</option>
                        <option value="2/3">2/3</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label>刷色</label>
                    <select id="print_color">
                        <option value="モノクロ">モノクロ</option>
                        <option value="カラー">カラー</option>
                        <option value="手彩色">手彩色</option>
                    </select>
                </div>
            </div>

            <label>備考</label>
            <textarea id="remarks" style="height:60px;"></textarea>

            <label>キーワード (スペース区切りで入力)</label>
            <input type="text" id="keywords" placeholder="例: 人物あり 昌徳宮 1930年">
            <span class="input-note" style="color:#666; margin-top:-8px;">※空白を入れると自動で区切られます</span>

            <!-- ★活字化機能追加 -->
            <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="chk-transcription" onchange="toggleTranscription()"
                        style="width:auto; margin:0 8px 0 0;">
                    活字化 (翻刻・テキストデータ) を追加する
                </label>
                <div id="transcription-area" style="display:none; margin-top:10px;">
                    <p style="font-size:12px; color:#555;">※内容を縦書きで入力できます。</p>
                    <textarea id="transcription_content" style="
                        width: 100%; 
                        height: 300px; 
                        writing-mode: vertical-rl; 
                        font-family: 'Yu Mincho', serif; 
                        padding: 10px; 
                        line-height: 2.0; 
                        font-size: 16px; 
                        border: 1px solid #999; 
                        background: #fffafa;"></textarea>
                </div>
            </div>

            <div style="background:#f9f9f9; padding:15px; margin-top:15px; border:1px dashed #ccc;">
                <label>【表面】画像 (必須)</label> <input type="file" id="imageFileFront" accept="image/*" required>
                <label>【裏面】画像</label> <input type="file" id="imageFileBack" accept="image/*">
            </div>

            <button type="submit" id="submitBtn" class="submit-btn">データベースに登録する</button>
        </form>

        <div id="status" style="margin-top:15px; color:blue; font-weight:bold;"></div>
        <a href="takada.html" style="display:block; text-align:center; margin-top:20px;">← 戻る</a>
    </div>

    <footer>
        <p style="margin-top:20px; opacity:0.6;">Digital Archive Project &copy; 2026 Curated by Yuya Ikeda</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD7UvBVllUkx5pSOk8DMc6Y3MNbTWELJzA",
            authDomain: "builderx-forik.firebaseapp.com",
            projectId: "builderx-forik",
            storageBucket: "builderx-forik.firebasestorage.app",
            messagingSenderId: "704985970287",
            appId: "1:704985970287:web:43924b7901b6f8f4df7f9a",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const USERS_COLLECTION = "allowed_users";
        const LOGS_COLLECTION = "activity_logs";
        const ALLOWED_DOMAIN = "ac.jp";

        async function checkPermission(user) {
            if (!user) return false;

            // 1. Check if user is explicitly allowed in database
            try {
                // Check if doc exists with UID (new system) or Email (legacy)
                // We'll query by email for broad compatibility
                const q = query(collection(db, USERS_COLLECTION), where("email", "==", user.email));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    // New System: Must be approved
                    if (data.status === 'approved') return true;
                    // Legacy System: if no status field but exists -> assume allow
                    if (!data.status) return true;

                    // If rejected or pending -> false
                    return false;
                }

                // 2. Domain Check for Uploaders (Allow all ac.jp) - ONLY if not explicitly rejected?
                // For now, let's keep the domain check as a fallback for users NOT in the allowed_users table.
                // But if they are in the table as 'rejected', they should be blocked.
                // WE already checked table above.
                if (user.email.endsWith(ALLOWED_DOMAIN)) return true;

                // Fallback for bootstrap (only if collection is empty)
                const allUsersQ = query(collection(db, USERS_COLLECTION), limit(1));
                const allUsersSnap = await getDocs(allUsersQ);
                if (allUsersSnap.empty) return true;

                return false;
            } catch (e) {
                console.error("Permission check failed:", e);
                return false;
            }
        }

        async function logActivity(action, details, targetId = null) {
            if (!auth.currentUser) return;
            try {
                await addDoc(collection(db, LOGS_COLLECTION), {
                    action: action, details: details, targetId: targetId,
                    user: auth.currentUser.email, timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Log failed:", e); }
        }

        const refInput = document.getElementById('refNo');
        refInput.addEventListener('input', (e) => {
            const val = e.target.value;
            const halfVal = val.replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
            e.target.value = halfVal.replace(/[^0-9-]/g, '');
        });

        // ★活字化エリア開閉
        window.toggleTranscription = () => {
            const chk = document.getElementById('chk-transcription');
            const area = document.getElementById('transcription-area');
            area.style.display = chk.checked ? 'block' : 'none';
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const allowed = await checkPermission(user);
                if (allowed) {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('upload-section').style.display = 'block';
                    document.getElementById('user-email-display').innerText = user.email;
                    document.getElementById('login-error').innerText = "";
                } else {
                    document.getElementById('login-error').innerText =
                        `エラー: ${user.email} は許可されていません。\n`;
                    signOut(auth);
                }
            } else {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('upload-section').style.display = 'none';
            }
        });

        window.loginWithGoogle = () => {
            signInWithPopup(auth, provider).catch((error) => {
                console.error(error);
                document.getElementById('login-error').innerText = "ログインに失敗しました: " + error.message;
            });
        };

        window.logout = () => { signOut(auth); };

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const status = document.getElementById('status');

            if (!auth.currentUser) { alert("認証エラー"); return; }

            btn.disabled = true; btn.innerText = "送信中...";
            status.innerText = "画像をアップロード中...";

            try {
                const fileFront = document.getElementById('imageFileFront').files[0];
                const fileBack = document.getElementById('imageFileBack').files[0];

                let urlFront = "";
                if (fileFront) {
                    const refFront = ref(storage, "images/" + Date.now() + "_front_" + fileFront.name);
                    await uploadBytes(refFront, fileFront);
                    urlFront = await getDownloadURL(refFront);
                }

                let urlBack = "";
                if (fileBack) {
                    const refBack = ref(storage, "images/" + Date.now() + "_back_" + fileBack.name);
                    await uploadBytes(refBack, fileBack);
                    urlBack = await getDownloadURL(refBack);
                }

                status.innerText = "DB登録中...";
                const keywordsStr = document.getElementById('keywords').value;
                const keywordArray = keywordsStr.split(/[,、\s　]+/).filter(k => k);

                // 活字化データの取得
                const isTrans = document.getElementById('chk-transcription').checked;
                const transContent = isTrans ? document.getElementById('transcription_content').value : "";

                const newData = {
                    refNo: document.getElementById('refNo').value,
                    form_type: document.getElementById('form_type').value,
                    title_jp: document.getElementById('title_jp').value,
                    title_en: document.getElementById('title_en').value,
                    publisher_jp: document.getElementById('publisher_jp').value,
                    publisher_en: document.getElementById('publisher_en').value,
                    usage_status: document.getElementById('usage_status').value,
                    postmark_date: document.getElementById('postmark_date').value,
                    divider_loc: document.getElementById('divider_loc').value,
                    print_color: document.getElementById('print_color').value,
                    remarks: document.getElementById('remarks').value,
                    transcription_content: transContent, // ★追加
                    keywords: keywordArray,
                    imageUrlFront: urlFront,
                    imageUrlBack: urlBack,
                    createdAt: serverTimestamp(),
                    uploader: auth.currentUser.email
                };

                const collectionName = document.getElementById('target_collection').value;
                const docRef = await addDoc(collection(db, collectionName), newData);

                // LOG
                logActivity('CREATE', `Created item ${newData.refNo} in ${collectionName}`, docRef.id);

                status.innerText = "登録完了！"; status.style.color = "green";
                document.getElementById('uploadForm').reset();
                document.getElementById('transcription-area').style.display = 'none'; // リセット時に隠す
                window.scrollTo(0, 0);

            } catch (error) {
                console.error(error);
                status.innerText = "エラー: " + error.message; status.style.color = "red";
            } finally {
                btn.disabled = false; btn.innerText = "データベースに登録する";
            }
        });
    </script>
</body>

</html>