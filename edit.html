<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>データ編集 | 関係者専用</title>
    <style>
        body {
            font-family: "Yu Mincho", serif;
            background-color: #f0f0f0;
            padding: 20px;
            color: #333;
        }

        .form-container {
            background: white;
            padding: 30px;
            border: 1px solid #ccc;
            max-width: 700px;
            margin: 0 auto;
        }

        h1 {
            font-size: 20px;
            border-bottom: 2px solid #555;
            padding-bottom: 10px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #aaa;
        }

        label {
            display: block;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .google-btn {
            background-color: #fff;
            color: #757575;
            border: 1px solid #ddd;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            font-family: "Roboto", sans-serif;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
        }

        .google-btn:hover {
            background-color: #f8f8f8;
        }

        .google-icon {
            width: 18px;
            height: 18px;
            margin-right: 10px;
        }

        button.submit-btn {
            background-color: #0056b3;
            color: white;
            padding: 12px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }

        button.submit-btn:hover {
            background-color: #004494;
        }

        /* 削除ボタンのデザイン（赤色） */
        button.delete-btn {
            background-color: #d9534f;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 40px;
            border-radius: 4px;
            opacity: 0.8;
        }

        button.delete-btn:hover {
            background-color: #c9302c;
            opacity: 1;
        }

        #login-section {
            text-align: center;
            max-width: 400px;
            margin: 50px auto;
            background: #fff;
            padding: 40px;
            border: 1px solid #ccc;
        }

        #edit-section {
            display: none;
        }

        .error-msg {
            color: red;
            font-weight: bold;
            margin-top: 15px;
            font-size: 13px;
        }

        .logout-btn {
            background-color: #666;
            font-size: 12px;
            padding: 5px 10px;
            color: #fff;
            border: none;
            cursor: pointer;
            float: right;
        }

        .input-note {
            font-size: 11px;
            color: #d00;
            margin-top: -8px;
            margin-bottom: 10px;
            display: block;
        }

        .current-img {
            width: 100px;
            height: auto;
            border: 1px solid #ccc;
            margin-bottom: 5px;
            display: block;
        }

        .nav-link- dashboard {
            display: inline-block;
            margin-top: 15px;
            font-size: 12px;
        }
    </style>
</head>

<body>

    <div id="login-section">
        <h2>資料管理者ログイン (編集)</h2>
        <p>データの修正には管理者権限が必要です。</p>
        <button class="google-btn" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-icon">
            Googleでログイン
        </button>
        <p id="login-error" class="error-msg"></p>
        <p style="font-size:12px; margin-top:20px;">
            <a href="admin.html">← 管理画面へ</a> | <a href="#" onclick="window.history.back();">戻る</a>
        </p>
    </div>

    <div id="edit-section" class="form-container">
        <div style="overflow:hidden;">
            <button class="logout-btn" onclick="logout()">ログアウト</button>
            <h1 style="margin-top:0;">データ編集・修正</h1>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <p style="font-size:12px; color:#0056b3;">※内容を書き換えて「更新保存」を押してください。</p>
            <a href="admin.html" style="font-size:12px;">管理者ダッシュボードへ</a>
        </div>

        <form id="editForm">
            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label class="required">整理番号</label>
                    <input type="text" id="refNo" required placeholder="例: 1-1-1" pattern="^[0-9-]+$">
                    <span class="input-note">※半角数字とハイフン(-)のみ</span>
                </div>
                <div style="flex:1;">
                    <label>形態</label>
                    <select id="form_type">
                        <option value="絵はがき">絵はがき</option>
                        <option value="絵はがき帳">絵はがき帳</option>
                        <option value="写真・アルバム">写真・アルバム</option>
                        <option value="書簡・封筒">書簡・封筒</option>
                        <option value="地図">地図</option>
                        <option value="書籍・冊子">書籍・冊子</option>
                        <option value="その他">その他</option>
                    </select>
                </div>
            </div>

            <label class="required">和文タイトル</label>
            <input type="text" id="title_jp" required>
            <label>英文タイトル</label>
            <input type="text" id="title_en">

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label>発行 (和文)</label> <input type="text" id="publisher_jp">
                </div>
                <div style="flex:1;">
                    <label>発行 (英文)</label> <input type="text" id="publisher_en">
                </div>
            </div>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label>使用/未使用</label>
                    <select id="usage_status">
                        <option value="">不明・指定なし</option>
                        <option value="未使用">未使用</option>
                        <option value="使用済み">使用済み</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label>消印日時</label> <input type="text" id="postmark_date">
                </div>
            </div>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label>仕切り線位置</label>
                    <select id="divider_loc">
                        <option value="-">-</option>
                        <option value="なし">なし</option>
                        <option value="1/3">1/3</option>
                        <option value="1/2">1/2</option>
                        <option value="2/3">2/3</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label>刷色</label>
                    <select id="print_color">
                        <option value="モノクロ">モノクロ</option>
                        <option value="カラー">カラー</option>
                        <option value="手彩色">手彩色</option>
                    </select>
                </div>
            </div>

            <label>備考</label>
            <textarea id="remarks" style="height:60px;"></textarea>

            <label>キーワード (スペース区切り)</label>
            <input type="text" id="keywords">

            <!-- ★活字化機能追加 -->
            <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="chk-transcription" onchange="toggleTranscription()"
                        style="width:auto; margin:0 8px 0 0;">
                    活字化 (翻刻・テキストデータ) を追加する
                </label>
                <div id="transcription-area" style="display:none; margin-top:10px;">
                    <p style="font-size:12px; color:#555;">※内容を縦書きで入力できます。</p>
                    <textarea id="transcription_content" style="
                        width: 100%; 
                        height: 300px; 
                        writing-mode: vertical-rl; 
                        font-family: 'Yu Mincho', serif; 
                        padding: 10px; 
                        line-height: 2.0; 
                        font-size: 16px; 
                        border: 1px solid #999; 
                        background: #fffafa;"></textarea>
                </div>
            </div>

            <div style="background:#f9f9f9; padding:15px; margin-top:15px; border:1px dashed #ccc;">
                <p style="font-size:12px; margin:0 0 10px 0; font-weight:bold;">画像を差し替える場合のみ選択してください</p>
                <label>【表面】画像</label>
                <img id="preview-front" class="current-img" src="">
                <input type="file" id="imageFileFront" accept="image/*">
                <label>【裏面】画像</label>
                <img id="preview-back" class="current-img" src="">
                <input type="file" id="imageFileBack" accept="image/*">
            </div>

            <button type="submit" id="submitBtn" class="submit-btn">更新内容を保存する</button>

            <button type="button" id="deleteBtn" class="delete-btn">このデータを完全に削除する</button>
        </form>

        <div id="status" style="margin-top:15px; color:#d9534f; font-weight:bold;"></div>
        <a href="#" onclick="window.history.back();" style="display:block; text-align:center; margin-top:20px;">←
            キャンセルして戻る</a>
    </div>

    <footer>
        <p style="margin-top:20px; opacity:0.6;">Digital Archive Project &copy; 2026 Curated by Yuya Ikeda</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs, addDoc, deleteDoc, updateDoc, query, where, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD7UvBVllUkx5pSOk8DMc6Y3MNbTWELJzA",
            authDomain: "builderx-forik.firebaseapp.com",
            projectId: "builderx-forik",
            storageBucket: "builderx-forik.firebasestorage.app",
            messagingSenderId: "704985970287",
            appId: "1:704985970287:web:43924b7901b6f8f4df7f9a",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const USERS_COLLECTION = "allowed_users";
        const LOGS_COLLECTION = "activity_logs";
        const ALLOWED_DOMAIN = "ac.jp";

        async function checkPermission(user) {
            if (!user) return false;

            // 1. Check if user is explicitly allowed in database
            try {
                const q = query(collection(db, USERS_COLLECTION), where("email", "==", user.email));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    // Must be approved
                    if (data.status === 'approved') return true;
                    // Legacy support
                    if (!data.status) return true;
                    return false;
                }

                // 2. Domain Check for Editors (Allow all ac.jp)
                // Fallback for domain users if they are NOT in the allowed_users (rejected users are blocked above if they are in the list)
                if (user.email.endsWith(ALLOWED_DOMAIN)) return true;

                // 3. Fallback for bootstrap
                const allUsersQ = query(collection(db, USERS_COLLECTION), limit(1));
                const allUsersSnap = await getDocs(allUsersQ);
                if (allUsersSnap.empty) return true;

                return false;
            } catch (e) {
                console.error("Check failed:", e);
                return false;
            }
        }

        async function logActivity(action, details, targetId = null) {
            if (!auth.currentUser) return;
            try {
                await addDoc(collection(db, LOGS_COLLECTION), {
                    action: action, details: details, targetId: targetId,
                    user: auth.currentUser.email, timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Log failed:", e); }
        }

        const params = new URLSearchParams(window.location.search);
        const docId = params.get('id');
        const collectionName = params.get('collection') || "items"; // Default to 'items'

        // 入力制限
        const refInput = document.getElementById('refNo');
        refInput.addEventListener('input', (e) => {
            const val = e.target.value;
            const halfVal = val.replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
            e.target.value = halfVal.replace(/[^0-9-]/g, '');
        });

        // 削除時に画像のURLが必要なので、読み込み時に保存しておく変数
        let currentData = null;

        // ★活字化エリア開閉
        window.toggleTranscription = () => {
            const chk = document.getElementById('chk-transcription');
            const area = document.getElementById('transcription-area');
            area.style.display = chk.checked ? 'block' : 'none';
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const allowed = await checkPermission(user);
                if (allowed) {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('edit-section').style.display = 'block';
                    document.getElementById('login-error').innerText = "";
                    loadDataForEdit();
                } else {
                    document.getElementById('login-error').innerText = `エラー: ${user.email} は許可されていません。`;
                    signOut(auth);
                }
            } else {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('edit-section').style.display = 'none';
            }
        });

        window.loginWithGoogle = () => {
            signInWithPopup(auth, provider).catch((error) => {
                console.error(error);
                document.getElementById('login-error').innerText = "ログイン失敗: " + error.message;
            });
        };

        window.logout = () => { signOut(auth); };

        async function loadDataForEdit() {
            if (!docId) { alert("エラー: IDが指定されていません"); return; }
            try {
                const docRef = doc(db, collectionName, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentData = data; // 削除用にデータを保持

                    setValue('refNo', data.refNo);
                    setValue('form_type', data.form_type);
                    setValue('title_jp', data.title_jp);
                    setValue('title_en', data.title_en);
                    setValue('publisher_jp', data.publisher_jp);
                    setValue('publisher_en', data.publisher_en);
                    setValue('usage_status', data.usage_status);
                    setValue('postmark_date', data.postmark_date);
                    setValue('divider_loc', data.divider_loc);
                    setValue('print_color', data.print_color);
                    setValue('remarks', data.remarks);
                    if (Array.isArray(data.keywords)) {
                        document.getElementById('keywords').value = data.keywords.join(" ");
                    }
                    if (data.imageUrlFront) document.getElementById('preview-front').src = data.imageUrlFront;
                    if (data.imageUrlBack) document.getElementById('preview-back').src = data.imageUrlBack;

                    // ★活字化データのロード
                    if (data.transcription_content) {
                        document.getElementById('chk-transcription').checked = true;
                        document.getElementById('transcription_content').value = data.transcription_content;
                        window.toggleTranscription();
                    } else {
                        document.getElementById('chk-transcription').checked = false;
                        window.toggleTranscription();
                    }

                } else { alert("データが見つかりません"); }
            } catch (e) { console.error(e); alert("読み込みエラー"); }
        }

        function setValue(id, val) { if (val) document.getElementById(id).value = val; }

        // 更新処理
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const status = document.getElementById('status');

            if (!auth.currentUser) { alert("認証エラー"); return; }

            btn.disabled = true; btn.innerText = "更新中...";
            status.innerText = "画像を処理中...";

            try {
                const fileFront = document.getElementById('imageFileFront').files[0];
                const fileBack = document.getElementById('imageFileBack').files[0];

                // ★活字化データの取得
                const isTrans = document.getElementById('chk-transcription').checked;
                const transContent = isTrans ? document.getElementById('transcription_content').value : "";

                const updateData = {
                    refNo: document.getElementById('refNo').value,
                    form_type: document.getElementById('form_type').value,
                    title_jp: document.getElementById('title_jp').value,
                    title_en: document.getElementById('title_en').value,
                    publisher_jp: document.getElementById('publisher_jp').value,
                    publisher_en: document.getElementById('publisher_en').value,
                    usage_status: document.getElementById('usage_status').value,
                    postmark_date: document.getElementById('postmark_date').value,
                    divider_loc: document.getElementById('divider_loc').value,
                    print_color: document.getElementById('print_color').value,
                    remarks: document.getElementById('remarks').value,
                    transcription_content: transContent, // ★追加
                    updatedAt: serverTimestamp(),
                    lastEditor: auth.currentUser.email
                };

                const keywordsStr = document.getElementById('keywords').value;
                updateData.keywords = keywordsStr.split(/[,、\s　]+/).filter(k => k);

                if (fileFront) {
                    const refFront = ref(storage, "images/" + Date.now() + "_front_" + fileFront.name);
                    await uploadBytes(refFront, fileFront);
                    updateData.imageUrlFront = await getDownloadURL(refFront);
                }
                if (fileBack) {
                    const refBack = ref(storage, "images/" + Date.now() + "_back_" + fileBack.name);
                    await uploadBytes(refBack, fileBack);
                    updateData.imageUrlBack = await getDownloadURL(refBack);
                }

                status.innerText = "データベース更新中...";
                const docRef = doc(db, collectionName, docId);
                await updateDoc(docRef, updateData);


                // LOG
                logActivity('UPDATE', `Updated item ${updateData.refNo} (${updateData.title_jp})`, docId);

                status.innerText = "更新完了！元のページに戻ります..."; status.style.color = "green";
                setTimeout(() => { window.history.back(); }, 1500);

            } catch (error) {
                console.error(error);
                status.innerText = "エラー: " + error.message; status.style.color = "red";
                btn.disabled = false; btn.innerText = "更新内容を保存する";
            }
        });

        // ★削除処理
        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (!confirm("本当にこのデータを削除しますか？\nこの操作は取り消せません。")) return;
            if (!auth.currentUser) { alert("認証エラー"); return; }

            const btn = document.getElementById('deleteBtn');
            btn.disabled = true; btn.innerText = "削除中...";

            try {
                // 1. 画像ファイルを削除（あれば）
                if (currentData.imageUrlFront) {
                    try {
                        const imgRef = ref(storage, currentData.imageUrlFront);
                        await deleteObject(imgRef);
                    } catch (e) { console.log("表面画像削除スキップ: " + e.message); }
                }
                if (currentData.imageUrlBack) {
                    try {
                        const imgRef = ref(storage, currentData.imageUrlBack);
                        await deleteObject(imgRef);
                    } catch (e) { console.log("裏面画像削除スキップ: " + e.message); }
                }

                // 2. データベースのドキュメントを削除
                await deleteDoc(doc(db, collectionName, docId));

                // LOG
                logActivity('DELETE', `Deleted item ${currentData.refNo} from ${collectionName}`, docId);

                alert("削除しました。一覧ページに戻ります。");
                window.location.href = "admin.html";

            } catch (error) {
                console.error(error);
                alert("削除中にエラーが発生しました: " + error.message);
                btn.disabled = false; btn.innerText = "このデータを完全に削除する";
            }
        });
    </script>
</body>

</html>