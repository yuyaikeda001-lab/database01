<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>データ編集 </title>
    <style>
        body { font-family: "Yu Mincho", serif; background-color: #f0f0f0; padding: 20px; color: #333; }
        .form-container { background: white; padding: 30px; border: 1px solid #ccc; max-width: 700px; margin: 0 auto; }
        h1 { font-size: 20px; border-bottom: 2px solid #555; padding-bottom: 10px; }
        
        input, select, textarea { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #aaa; }
        label { display: block; font-weight: bold; margin-top: 15px; margin-bottom: 5px; font-size: 14px; }
        
        .google-btn {
            background-color: #fff; color: #757575; border: 1px solid #ddd; padding: 10px 20px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; width: 100%; font-family: "Roboto", sans-serif; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background-color 0.2s;
        }
        .google-btn:hover { background-color: #f8f8f8; }
        .google-icon { width: 18px; height: 18px; margin-right: 10px; }

        /* 保存ボタンは色を変えて区別 */
        button.submit-btn { background-color: #d9534f; color: white; padding: 12px; border: none; cursor: pointer; font-size: 16px; width: 100%; margin-top: 20px; }
        button.submit-btn:hover { background-color: #c9302c; }

        #login-section { text-align: center; max-width: 400px; margin: 50px auto; background: #fff; padding: 40px; border: 1px solid #ccc; }
        #edit-section { display: none; }
        
        .error-msg { color: red; font-weight: bold; margin-top: 15px; font-size: 13px;}
        .logout-btn { background-color: #666; font-size: 12px; padding: 5px 10px; color: #fff; border: none; cursor: pointer; float: right; }
        .input-note { font-size: 11px; color: #d00; margin-top: -8px; margin-bottom: 10px; display: block; }

        /* 現在の画像表示用 */
        .current-img { width: 100px; height: auto; border: 1px solid #ccc; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

    <div id="login-section">
        <h2>資料登録者ログイン (編集)</h2>
        <p>データの修正には許可されたドメインの<br>Googleアカウントが必要です。</p>
        <button class="google-btn" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-icon">
            Googleでログイン
        </button>
        <p id="login-error" class="error-msg"></p>
        <p style="font-size:12px; margin-top:20px;"><a href="#" onclick="window.history.back();">← 元のページに戻る</a></p>
    </div>

    <div id="edit-section" class="form-container">
        <div style="overflow:hidden;">
            <button class="logout-btn" onclick="logout()">ログアウト</button>
            <h1 style="margin-top:0;">データ編集・修正</h1>
        </div>
        <p style="font-size:12px; color:#d9534f;">※内容を書き換えて「更新保存」を押してください。</p>

        <form id="editForm">
            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label class="required">整理番号</label>
                    <input type="text" id="refNo" required placeholder="例: 1-1-1" pattern="^[0-9-]+$">
                    <span class="input-note">※半角数字とハイフン(-)のみ</span>
                </div>
                <div style="flex:1;">
                    <label>形態</label>
                    <select id="form_type">
                        <option value="絵はがき">絵はがき</option>
                        <option value="絵はがき帳">絵はがき帳</option>
                        <option value="写真・アルバム">写真・アルバム</option>
                        <option value="書簡・封筒">書簡・封筒</option>
                        <option value="地図">地図</option>
                        <option value="書籍・冊子">書籍・冊子</option>
                        <option value="その他">その他</option>
                    </select>
                </div>
            </div>

            <label class="required">和文タイトル</label>
            <input type="text" id="title_jp" required>
            <label>英文タイトル</label>
            <input type="text" id="title_en">

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label>発行 (和文)</label> <input type="text" id="publisher_jp">
                </div>
                <div style="flex:1;">
                    <label>発行 (英文)</label> <input type="text" id="publisher_en">
                </div>
            </div>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label>使用/未使用</label>
                    <select id="usage_status">
                        <option value="">不明・指定なし</option>
                        <option value="未使用">未使用</option>
                        <option value="使用済み">使用済み</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label>消印日時</label> <input type="text" id="postmark_date">
                </div>
            </div>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label>仕切り線位置</label>
                    <select id="divider_loc">
                        <option value="-">-</option>
                        <option value="なし">なし</option>
                        <option value="1/3">1/3</option>
                        <option value="1/2">1/2</option>
                        <option value="2/3">2/3</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label>刷色</label>
                    <select id="print_color">
                        <option value="モノクロ">モノクロ</option>
                        <option value="カラー">カラー</option>
                        <option value="手彩色">手彩色</option>
                    </select>
                </div>
            </div>

            <label>備考</label>
            <textarea id="remarks" style="height:60px;"></textarea>

            <label>キーワード (スペース区切り)</label>
            <input type="text" id="keywords">

            <div style="background:#fff5f5; padding:15px; margin-top:15px; border:1px dashed #d9534f;">
                <p style="font-size:12px; margin:0 0 10px 0; font-weight:bold;">画像を差し替える場合のみ選択してください</p>
                
                <label>【表面】画像</label>
                <img id="preview-front" class="current-img" src="">
                <input type="file" id="imageFileFront" accept="image/*">
                
                <label>【裏面】画像</label>
                <img id="preview-back" class="current-img" src="">
                <input type="file" id="imageFileBack" accept="image/*">
            </div>

            <button type="submit" id="submitBtn" class="submit-btn">更新内容を保存する</button>
        </form>
        
        <div id="status" style="margin-top:15px; color:#d9534f; font-weight:bold;"></div>
        <a href="#" onclick="window.history.back();" style="display:block; text-align:center; margin-top:20px;">← キャンセルして戻る</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
     const firebaseConfig = {
       apiKey: "AIzaSyD7UvBVllUkx5pSOk8DMc6Y3MNbTWELJzA",
       authDomain: "builderx-forik.firebaseapp.com",
       projectId: "builderx-forik",
       storageBucket: "builderx-forik.firebasestorage.app",
       messagingSenderId: "704985970287",
       appId: "1:704985970287:web:43924b7901b6f8f4df7f9a",
    }; 
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // URLからIDを取得
        const params = new URLSearchParams(window.location.search);
        const docId = params.get('id');

        // 入力制限
        const refInput = document.getElementById('refNo');
        refInput.addEventListener('input', (e) => {
            const val = e.target.value;
            const halfVal = val.replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
            e.target.value = halfVal.replace(/[^0-9-]/g, '');
        });

        // 認証チェック
        const ALLOWED_DOMAIN = "ac.jp"; 

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.email.endsWith(ALLOWED_DOMAIN)) {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('edit-section').style.display = 'block';
                    document.getElementById('login-error').innerText = "";
                    // ログインできたらデータを読み込む
                    loadDataForEdit();
                } else {
                    document.getElementById('login-error').innerText = `エラー: ${user.email} は許可されていません。`;
                    logout();
                }
            } else {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('edit-section').style.display = 'none';
            }
        });

        window.loginWithGoogle = () => {
            signInWithPopup(auth, provider).catch((error) => {
                console.error(error);
                document.getElementById('login-error').innerText = "ログイン失敗";
            });
        };

        window.logout = () => { signOut(auth); };

        // ★既存データを読み込んでフォームに入れる関数
        async function loadDataForEdit() {
            if(!docId) { alert("エラー: IDが指定されていません"); return; }

            try {
                const docRef = doc(db, "items", docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();

                    // 各フィールドに値をセット
                    setValue('refNo', data.refNo);
                    setValue('form_type', data.form_type);
                    setValue('title_jp', data.title_jp);
                    setValue('title_en', data.title_en);
                    setValue('publisher_jp', data.publisher_jp);
                    setValue('publisher_en', data.publisher_en);
                    setValue('usage_status', data.usage_status);
                    setValue('postmark_date', data.postmark_date);
                    setValue('divider_loc', data.divider_loc);
                    setValue('print_color', data.print_color);
                    setValue('remarks', data.remarks);

                    // キーワードは配列からスペース区切り文字列に戻す
                    if(Array.isArray(data.keywords)){
                        document.getElementById('keywords').value = data.keywords.join(" ");
                    }

                    // 画像プレビュー
                    if(data.imageUrlFront) document.getElementById('preview-front').src = data.imageUrlFront;
                    if(data.imageUrlBack) document.getElementById('preview-back').src = data.imageUrlBack;

                } else {
                    alert("データが見つかりません");
                }
            } catch(e) {
                console.error(e);
                alert("読み込みエラー");
            }
        }

        function setValue(id, val) {
            if(val) document.getElementById(id).value = val;
        }

        // ★更新処理
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const status = document.getElementById('status');
            
            if (!auth.currentUser) { alert("認証エラー"); return; }

            btn.disabled = true; btn.innerText = "更新中...";
            status.innerText = "画像を処理中...";

            try {
                const fileFront = document.getElementById('imageFileFront').files[0];
                const fileBack = document.getElementById('imageFileBack').files[0];

                // 更新用のデータオブジェクト
                const updateData = {
                    refNo: document.getElementById('refNo').value,
                    form_type: document.getElementById('form_type').value,
                    title_jp: document.getElementById('title_jp').value,
                    title_en: document.getElementById('title_en').value,
                    publisher_jp: document.getElementById('publisher_jp').value,
                    publisher_en: document.getElementById('publisher_en').value,
                    usage_status: document.getElementById('usage_status').value,
                    postmark_date: document.getElementById('postmark_date').value,
                    divider_loc: document.getElementById('divider_loc').value,
                    print_color: document.getElementById('print_color').value,
                    remarks: document.getElementById('remarks').value,
                    updatedAt: serverTimestamp(), // 更新日時
                    lastEditor: auth.currentUser.email
                };

                // キーワードの処理
                const keywordsStr = document.getElementById('keywords').value;
                updateData.keywords = keywordsStr.split(/[,、\s　]+/).filter(k => k);

                // 画像に変更がある場合のみアップロードしてURLを更新
                if (fileFront) {
                    const refFront = ref(storage, "images/" + Date.now() + "_front_" + fileFront.name);
                    await uploadBytes(refFront, fileFront);
                    updateData.imageUrlFront = await getDownloadURL(refFront);
                }

                if (fileBack) {
                    const refBack = ref(storage, "images/" + Date.now() + "_back_" + fileBack.name);
                    await uploadBytes(refBack, fileBack);
                    updateData.imageUrlBack = await getDownloadURL(refBack);
                }

                status.innerText = "データベース更新中...";

                // Firestoreを更新 (updateDocを使うと、指定した項目だけ書き換わります)
                const docRef = doc(db, "items", docId);
                await updateDoc(docRef, updateData);

                status.innerText = "更新完了！元のページに戻ります...";
                status.style.color = "green";
                
                // 少し待ってから詳細ページに戻る
                setTimeout(() => {
                    window.location.href = `detail.html?id=${docId}`;
                }, 1500);

            } catch (error) {
                console.error(error);
                status.innerText = "エラー: " + error.message; status.style.color = "red";
                btn.disabled = false; btn.innerText = "更新内容を保存する";
            }
        });
    </script>
</body>
</html>